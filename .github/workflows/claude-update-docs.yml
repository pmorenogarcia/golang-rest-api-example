name: Claude Update Documentation

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  update-docs:
    # ONLY trigger on the exact command
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude-update-docs')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude-update-docs'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Configure Git
        run: |
          git config --global user.name "Claude Code Bot"
          git config --global user.email "claude-code-bot@anthropic.com"

      - name: Install docs validation hook
        run: |
          chmod +x .github/scripts/validate-docs-only.sh
          mkdir -p .git/hooks
          cat > .git/hooks/pre-commit << 'EOF'
          #!/bin/bash
          exec .github/scripts/validate-docs-only.sh
          EOF
          chmod +x .git/hooks/pre-commit
          echo "âœ… Pre-commit hook installed"

      - name: Update Documentation with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Focused prompt for documentation updates ONLY
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            The user has requested documentation updates with the command: @claude-update-docs

            **Your task:**
            1. Analyze this PR and identify ALL endpoint changes (new, modified, or deleted)
            2. Read the current Postman collection from docs/postman/Pokemon_API.postman_collection.json
            3. Generate an updated Postman collection that includes:
               - New requests for new endpoints with examples
               - Updated requests for modified endpoints
               - Removed requests for deleted endpoints
            4. Update README.md if it contains API documentation
            5. Use git to stage ONLY documentation files
            6. Create a single commit: "docs: update API documentation for [describe changes]"
            7. Push the commit to this PR branch

            **Remember:**
            - You can ONLY write to docs/ folder and README.md, API.md, ENDPOINTS.md, CHANGELOG.md
            - Pre-commit hook will BLOCK commits with non-documentation files
            - Use descriptive commit messages
            - Provide examples in Postman requests

          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 20
            --system-prompt "ðŸ”’ SECURITY: You have WRITE access ONLY to docs/ folder and root documentation files (README.md, API.md, ENDPOINTS.md, CHANGELOG.md). A pre-commit hook will BLOCK any attempt to commit other files.\n\nðŸŽ¯ TASK: Update API documentation based on endpoint changes in this PR. Be thorough and accurate."
            --allowedTools Bash(git add),Bash(git commit),Bash(git push),Bash(git status),Bash(git diff)

          settings: |
            {
              "env": {
                "GO_ENV": "test"
              }
            }
